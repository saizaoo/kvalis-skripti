<group name="ad_bruteforce,windows,authentication_failed,">
  <rule id="100010" level="10" frequency="6" timeframe="60">
    <if_matched_sid>60122</if_matched_sid>
    <field name="win.system.eventID">^4625$</field>
    <field name="win.eventdata.logonType">^3$</field>
    <same_field>win.eventdata.ipAddress</same_field>

    <description>AD paroļu pārlases uzbrukums caur RDP no vienas IP adreses (>=6 nepareizi mēģinājumi 60 sekundēs)</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_bruteforce,network,suricata,">
  <rule id="100115" level="2">
    <if_sid>86600</if_sid>
    <field name="event_type">^krb5$</field>
    <field name="krb5.failed_request">^KRB_AS_REQ$</field>
    <field name="krb5.error_code">^KDC_ERR_PREAUTH_FAILED$</field>

    <description>Neveiksmīgs AS_REQ ar KDC_ERR_PREAUTH_FAILED tīklā</description>
  </rule>
</group>

<group name="ad_bruteforce,network,suricata,">
  <rule id="100015" level="10" frequency="6" timeframe="60">
    <if_matched_sid>100115</if_matched_sid>
    <same_field>dest_ip</same_field>

    <description>AD paroļu pārlase pret Kerberos (>=6 neveiksmīgi AS_REQ ar KDC_ERR_PREAUTH_FAILED 60s laikā uz vienu IP) tīklā</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_kerberos,windows,">
  <rule id="100020" level="12">
    <if_sid>60103</if_sid>
    <field name="win.system.eventID">^4769$</field>
    <field name="win.eventdata.TicketOptions" type="pcre2">^0x408100[01]0$</field>
    <field name="win.eventdata.TargetUserName" type="pcre2">^[^$]+$</field>
    <field name="win.eventdata.serviceName" type="pcre2">^[^$]+$</field>
    <field name="win.eventdata.IpAddress" type="pcre2">^(?!::1$|127\.0\.0\.1$).*</field>

    <description>Aizdomīgs Kerberos servisa biļetes pieprasījums (iespējama viltota biļete / Kerberos uzbrukums)</description>
    <mitre>
      <id>T1558</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_kerberos,network,zeek,">
  <rule id="100025" level="12">
    <decoded_as>zeek_decoder</decoded_as>
    <field name="krb_request_type">^TGS$</field>
    <field name="cipher" type="pcre2">(?i)^rc4-hmac$</field>
    <field name="service" type="pcre2">^[^$]+$</field>

    <description>Aizdomīgs Kerberos TGS pieprasījums ar RC4 šifru (iespējams Kerberoasting tīklā)</description>
    <mitre>
      <id>T1558.003</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_asrep_roasting,windows,">
  <rule id="100030" level="12">
    <if_sid>60103</if_sid>
    <field name="win.system.eventID">^4768$</field>
    <field name="win.eventdata.preAuthType">^0$</field>
    <field name="win.eventdata.serviceName">^krbtgt$</field>
    
    <description>Iespējams AS-REP Roasting</description>
    <mitre>
      <id>T1558.004</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_dcsync,windows,">
  <rule id="100140" level="2">
    <if_sid>60103</if_sid>
    <field name="win.system.eventID">^4662$</field>
    <field name="win.eventdata.properties" type="pcre2">
      {1131f6aa-9c07-11d1-f79f-00c04fc2dcd2}|{1131f6ad-9c07-11d1-f79f-00c04fc2dcd2}|{89e95b76-444d-4c62-991a-0facbeda640c}
    </field>
    
    <description>Directory Service Access - iespējams DCSync (izmantotas replikācijas privilēģijas)</description>
    <mitre>
      <id>T1003.006</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
  
  <rule id="100040" level="12" frequency="10" timeframe="60">
    <if_matched_sid>100140</if_matched_sid>
    
    <description>>=10 Directory Service Access notikumi 60 sekundēs - iespējams DCSync (izmantotas replikācijas privilēģijas)</description>
    <mitre>
      <id>T1003.006</id>
    </mitre>
    <options>no_full_log</options>
  </rule>

  <rule id="100041" level="0">
    <if_sid>60103</if_sid>
    <field name="win.system.eventID">^4662$</field>
    <field name="win.eventdata.properties" type="pcre2">
      {1131f6aa-9c07-11d1-f79f-00c04fc2dcd2}|{1131f6ad-9c07-11d1-f79f-00c04fc2dcd2}|{89e95b76-444d-4c62-991a-0facbeda640c}
    </field>
    <field name="win.eventdata.SubjectUserName" type="pcre2">\$$</field>
    
    <description>Ignorē Directory Service Access replikācijas privilēģijas no datoru kontiem</description>
    <options>no_full_log</options>
  </rule>
</group>

<group name="network,zeek,">
  <rule id="100145" level="2">
    <decoded_as>zeek_decoder</decoded_as>
    <field name="endpoint">^drsuapi$</field>
    <field name="operation">^DRSGetNCChanges$</field>

    <description>DRSUAPI DRSGetNCChanges RPC pieprasījums - iespējams DCSync tīklā</description>
    <mitre>
      <id>T1003.006</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_dcsync,network,zeek,">
  <rule id="100045" level="12" frequency="10" timeframe="60">
    <if_matched_sid>100145</if_matched_sid>

    <description>>=10 DRSUAPI DRSGetNCChanges RPC pieprasījumi 60 sekundēs - iespējams DCSync tīklā</description>
    <mitre>
      <id>T1003.006</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_golden_ticket,windows,">
  <rule id="100050" level="12">
    <if_sid>60103</if_sid>
    <field name="win.system.eventID">^4624$</field>
    <field name="win.eventdata.logonType">^3$</field>
    <field name="win.eventdata.AuthenticationPackageName">^Kerberos$</field>
    <field name="win.eventdata.TargetUserSid" type="pcre2">-500$</field>

    <description>Aizdomīga Kerberos tīkla pieteikšanās ar iebūvēto Administrator kontu (iespējams Golden Ticket vai cits Kerberos biļetes viltojums)</description>
    <mitre>
      <id>T1558.001</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_pass_the_hash,windows,">
  <rule id="100060" level="12">
    <if_sid>60103</if_sid>
    <field name="win.system.eventID">^4624$</field>
    <field name="win.eventdata.logonType">^3$</field>
    <field name="win.eventdata.AuthenticationPackageName">^NTLM$</field>
    <field name="win.eventdata.TargetUserSid" type="pcre2">-500$</field>

    <description>Aizdomīga NTLM tīkla pieteikšanās ar iebūvēto Administrator kontu (iespējams Pass the Hash)</description>
    <mitre>
      <id>T1550.002</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_pass_the_hash,windows,">
  <rule id="100061" level="4">
    <if_sid>60103</if_sid>
    <field name="win.system.eventID">^4624$</field>
    <field name="win.eventdata.logonType">^10$</field>
    <field name="win.eventdata.AuthenticationPackageName">Negotiate</field>
    <field name="win.eventdata.TargetUserSid" type="pcre2">-500$</field>

    <description>RDP NTLM pieteikšanās ar iebūvēto Administrator kontu - norāda, ka šo bridinājumu pavadošs bridinājums 100060 ir visdrīzāk kļūdaina atbilsme</description>
  </rule>
</group>

<group name="ad_ntds_exfil,windows,">
  <rule id="100070" level="12">
    <if_sid>92032</if_sid>
    <field name="win.system.providerName">^Microsoft-Windows-Sysmon$</field>
    <field name="win.system.eventID">^1$</field>
    <field name="win.eventdata.commandLine" type="pcre2">HarddiskVolumeShadowCopy</field>
    <field name="win.eventdata.commandLine" type="pcre2">ntds\.dit</field>

    <description>Aizdomīga NTDS.dit kopēšana no VSS ēnkopijas (iespējama NTDS datubāzes eksfiltrācija)</description>
    <mitre>
      <id>T1003.003</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_ntds_exfil,windows,">
  <rule id="100071" level="10">
    <if_sid>67027</if_sid>
    <field name="win.system.eventID">^4688$</field>
    <field name="win.eventdata.newProcessName" type="pcre2">\\ntdsutil\.exe$</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)\bifm\b</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)create full</field>

    <description>Aizdomīga NTDS datubāzes IFM kopijas izveide ar ntdsutil (iespējama NTDS.dit eksfiltrācija)</description>
    <mitre>
      <id>T1003.003</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_ntds_exfil,windows,">
  <rule id="100072" level="10">
    <if_sid>67027</if_sid>
    <field name="win.system.eventID">^4688$</field>
    <field name="win.eventdata.newProcessName" type="pcre2">\\diskshadow\.exe$</field>
    <field name="win.eventdata.commandLine" type="pcre2">(?i)diskshadow\.exe.*\s\/s\s</field>

    <description>Aizdomīga diskshadow palaišana ar skripta parametru (iespējama VSS ēnkopiju ļaunprātīga izmantošana)</description>
    <mitre>
      <id>T1003.003</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_ntds_exfil,windows,">
  <rule id="100073" level="10">
    <if_sid>61603</if_sid>
    <field name="win.system.providerName">^Microsoft-Windows-Sysmon$</field>
    <field name="win.system.eventID">^1$</field>
    <field name="win.eventdata.image" type="pcre2">\\diskshadow\.exe$</field>
    <field name="win.eventdata.parentImage" type="pcre2">(powershell|cmd|wmic|psexesvc|winrshost)\.exe$</field>

    <description>Aizdomīga diskshadow palaišana no komandrindas / attālās izpildes rīka (iespējama VSS izmantošana piekļuves datu iegūšanai)</description>
    <mitre>
      <id>T1003.003</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>

<group name="ad_ntds_exfil,network,zeek,">
  <rule id="100075" level="12">
    <decoded_as>zeek_decoder</decoded_as>
    <field name="smb_action">^SMB::FILE_OPEN$</field>
    <field name="name" type="pcre2">(?i)ntds\.dit$</field>

    <description>Aizdomīga NTDS.dit faila piekļuve pa SMB (iespējama NTDS datubāzes eksfiltrācija tīklā)</description>
    <mitre>
      <id>T1003.003</id>
    </mitre>
    <options>no_full_log</options>
  </rule>
</group>
